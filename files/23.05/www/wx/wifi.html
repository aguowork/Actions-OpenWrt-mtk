<!DOCTYPE html>
<html>

<head>
    <title>系统配置</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Helvetica Neue', sans-serif;
            background-color: #181818;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        h2 {
            color: #ffffff;
            margin-bottom: 15px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        p {
            color: #ffd700;
            line-height: 1.6;
        }

        label {
            margin-top: 10px;
            display: block;
            font-weight: bold;
            color: #ffffff;
        }

        input[type="text"],
        input[type="password"] {
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            background-color: #282828;
            color: #ffffff;
            transition: border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            border-color: #66bb6a;
            outline: none;
        }

        input[type="button"] {
            background-color: #4CAF50;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin: 15px auto 0;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="button"]:hover {
            background-color: #45a049;
        }

        .container {
            background-color: #282828;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            padding: 30px;
            max-width: 90%;
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .hidden {
            display: none;
        }

        .config-container {
            align-items: flex-start;
        }

        .current-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .current-info p {
            margin: 5px 0;
            max-width: 100%;
            overflow-wrap: break-word;
        }

        .config-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        @media (max-width: 768px) {
            h2 {
                font-size: 18px;
            }

            label {
                font-size: 14px;
            }

            input[type="text"],
            input[type="password"] {
                padding: 10px;
                font-size: 14px;
            }

            input[type="button"] {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3e%3cpath d='M7 10l5 5 5-5z' fill='%23ffd700'/%3e%3c/svg%3e") no-repeat right 0.75rem center/1.5em auto;
            padding: 10px;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            color: #ffd700;
            background-color: #282828;
            box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        select:focus {
            border-color: #66bb6a;
            outline: none;
        }
    </style>
    <script>
        // 加载 WiFi 配置信息的函数
        function loadWiFiConfigs() {
            console.log("加载 WiFi 配置信息");
            const select = document.getElementById('wifiNameSelect');
            // 检查是否存在
            if (!select) {
                console.error("未找到 WiFi 选择框 (wifiNameSelect)");
                return;
            }

            // 使用 fetch 方法请求 wifi-config.json 文件
            fetch('wifi-config.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('无法加载 wifi-config.json 文件');
                    }
                    return response.json();
                })
                .then(data => {
                    let wifiPasswords = {};
                    
                    // 清空下拉框选项，避免重复添加
                    select.innerHTML = '<option value="">手动输入</option>';

                    const wifiList = data.wifi;
                    wifiList.forEach(wifi => {
                        const option = document.createElement('option');
                        option.value = wifi.name;
                        option.textContent = wifi.name;
                        select.appendChild(option);
                        wifiPasswords[wifi.name] = wifi.password;
                    });

                    // 监听下拉菜单的变化事件
                    select.addEventListener('change', function () {
                        const wifiName = this.value;
                        document.getElementById('wifiNameInput').value = wifiName;
                        document.getElementById('wifiPwd').value = wifiPasswords[wifiName] || '';
                        const selectedWifi = wifiList.find(wifi => wifi.name === wifiName);
                        if (selectedWifi) {
                            document.getElementById('wifiBand').value = selectedWifi.band.toUpperCase();
                        } else {
                            document.getElementById('wifiBand').value = '';
                        }
                    });

                    document.getElementById('wifiNameInput').addEventListener('input', function () {
                        const wifiName = this.value;
                        document.getElementById('wifiPwd').value = wifiPasswords[wifiName] || '';
                        select.value = '';
                        document.getElementById('wifiBand').value = '';
                    });
                })
                .catch(error => {
                    console.error(error);
                    select.innerHTML = '<option value="">手动输入</option>';
                });
        }

        function checkPassword(event) {
            if (event.key === 'Enter' || event.type === 'click') {
                var password = document.getElementById('password').value;
                if (password === 'admin') {
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('configContainer').classList.remove('hidden');
                    
                    // 在密码验证成功后，显示配置容器并加载 WiFi 配置信息
                    loadWiFiConfigs(); // 这里放在配置页面显示之后
                    fetchCurrentConfig();
                } else {
                    alert('密码错误，请重试。');
                }
            }
        }

        function saveConfig() {
            var currentInterface = document.getElementById('currentInterface').textContent;
            if (currentInterface !== 'wwan') {
                alert('没有 wwan 接口无法执行中继');
                return;
            }

            var wifiName = document.getElementById('wifiNameInput').value || document.getElementById('wifiNameSelect').value;
            var wifiPwd = document.getElementById('wifiPwd').value;
            var wifiBand = document.getElementById('wifiBand').value;

            if (!wifiName || !wifiPwd || (!document.getElementById('wifiNameSelect').value && !wifiBand)) {
                alert('请填写完整 WiFi 名称、密码、频段。');
                return;
            }

            var confirmMessage = '\n热点名称：' + wifiName + '\n热点密码：' + wifiPwd + '\n频段：' + wifiBand + '\n\n确定切换到该热点吗？';
            if (!confirm(confirmMessage)) {
                return;
            }

            var wifiConfig = {
                "name": wifiName,
                "password": wifiPwd,
                "band": wifiBand
            };

            var xhr1 = new XMLHttpRequest();
            xhr1.open('POST', '/cgi-bin/wx/save_wifi_config.sh', true);
            xhr1.setRequestHeader('Content-Type', 'application/json');
            xhr1.onreadystatechange = function () {
                if (xhr1.readyState === 4 && xhr1.status === 200) {
                    console.log('WiFi 配置保存成功！');
                    // 移除重新加载 WiFi 配置的调用
                    // loadWiFiConfigs(); 
                } else if (xhr1.readyState === 4) {
                    alert('保存失败，请重试。');
                }
            };
            xhr1.send(JSON.stringify(wifiConfig));

            var xhr2 = new XMLHttpRequest();
            xhr2.open('POST', '/cgi-bin/wx/config.sh', true);
            xhr2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr2.onreadystatechange = function () {
                if (xhr2.readyState === 4 && xhr2.status === 200) {
                    document.body.innerHTML = xhr2.responseText;
                }
            };
            xhr2.send('ssid=' + wifiName + '&key=' + wifiPwd + '&band=' + wifiBand);
        }

        function fetchCurrentConfig() {
            var xhr3 = new XMLHttpRequest();
            xhr3.open('GET', '/cgi-bin/wx/get_config.sh', true);
            xhr3.onreadystatechange = function () {
                if (xhr3.readyState === 4 && xhr3.status === 200) {
                    var response = JSON.parse(xhr3.responseText);
                    document.getElementById('currentSSID').textContent = response.ssid;
                    document.getElementById('currentKEY').textContent = response.key;
                    document.getElementById('currentBand').textContent = response.band.toUpperCase();
                    document.getElementById('currentInterface').textContent = response.interface;
                    document.getElementById('currentBridgeStatus').textContent = response.bridge_status;
                }
            };
            xhr3.send();
        }
    </script>
</head>

<body>
    <!-- 密码输入容器 -->
    <div class="container" id="loginContainer">
        <h2>管理密码</h2>
        <input type="password" id="password" placeholder="输入密码" onkeydown="checkPassword(event)">
        <input type="button" value="确认" onclick="checkPassword(event)">
    </div>

    <!-- 配置容器，初始隐藏 -->
    <div class="container hidden config-container" id="configContainer">
        <div class="current-info">
            <h2>当前中继热点</h2>
            <p>名称：<span id="currentSSID"></span></p>
            <p>密码：<span id="currentKEY"></span></p>
            <p>频段：<span id="currentBand"></span></p>
            <p>接口：<span id="currentInterface"></span></p>
            <p>状态：<span id="currentBridgeStatus"></span></p>
        </div>
        <div class="config-section">
            <h2>切换热点配置</h2>
            <label for="wifiNameSelect">已知热点</label>
            <select id="wifiNameSelect">
                <option value="">手动输入</option>
            </select>

            <label for="wifiNameInput">WiFi名称</label>
            <input type="text" id="wifiNameInput" placeholder="输入你知道的WiFi" />

            <label for="wifiPwd">WiFi密码</label>
            <input type="password" id="wifiPwd" value="" />

            <label for="wifiBand">WiFi频段</label>
            <select id="wifiBand">
                <option value="" disabled selected hidden>请选择频段</option>
                <option value="2G">2.4G</option>
                <option value="5G">5G</option>
            </select>

            <input type="button" value="保存应用" onclick="saveConfig()">
        </div>
    </div>
</body>

</html>
